<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›”ê°„ ê·¼ë¬´í‘œ (Supabase Ver.)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* âœ… CSS ë³€ìˆ˜ ì •ì˜ - ë¼ì´íŠ¸/ë‹¤í¬ ëª¨ë“œ */
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #ddd;
            --tab-bg: #f8f9fa;
            --tab-text: #495057;
            --tab-active-bg: #e9ecef;
            --input-bg: #ffffff;
            --input-border: #ccc;
            --table-header-bg: #ffffff;
            --table-cell-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --loading-text: #666;
            --error-text: #ff3333;
            --info-text: #ff9900;
            --turn-hyu: #ffcccc;
            --turn-dae: #d4f4c9;
            --turn-default: #e0e0e0;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a2e;
            --text-color: #e0e0e0;
            --border-color: #3a3a5a;
            --tab-bg: #16213e;
            --tab-text: #b0b0c0;
            --tab-active-bg: #0f3460;
            --input-bg: #16213e;
            --input-border: #3a3a5a;
            --table-header-bg: #16213e;
            --table-cell-bg: #1a1a2e;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --loading-text: #888;
            --error-text: #ff6b6b;
            --info-text: #ffc107;
            --turn-hyu: #5c3a3a;
            --turn-dae: #3a5c3a;
            --turn-default: #4a4a4a;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            text-align: center;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .tabs {
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 10;
            background-color: var(--tab-bg);
            border-top: 1px solid var(--border-color);
        }

        .tab {
            flex-grow: 1;
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            border-left: 1px solid var(--border-color);
            font-weight: bold;
            color: var(--tab-text);
            font-size: 14px;
            background-color: var(--tab-bg);
            transition: background-color 0.3s, color 0.3s;
        }
        .tab:first-child { border-left: none; }
        .tab.active {
            background-color: var(--tab-active-bg);
            border-bottom: 3px solid #4a90d9;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 5px;
            align-items: center;
            flex-wrap: wrap; 
        }
        .controls input[type="month"],
        .controls input[type="text"],
        .controls button {
            padding: 5px;
            font-size: 14px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .controls button {
            background-color: #4a90d9;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        .controls button:hover {
            background-color: #3a7bc8;
        }

        /* âœ… ë‹¤í¬ëª¨ë“œ í† ê¸€ ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .theme-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4a90d9;
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .theme-icon {
            font-size: 16px;
            user-select: none;
        }

        .table-container {
            width: 100%;
            height: 600px; 
            overflow-x: auto;
            overflow-y: scroll;
            position: relative;
            border: 1px solid var(--border-color);
            margin: 0 auto;
            padding-bottom: 50px;
            background-color: var(--bg-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        table {
            border-collapse: collapse;
            width: auto;
            min-width: 600px;
        }

        th,
        td {
            border: 1px solid var(--border-color);
            padding: 6px;
            text-align: center;
            font-size: 12px;
            white-space: nowrap;
            transition: border-color 0.3s;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            background-color: var(--table-header-bg);
            z-index: 5;
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: background-color 0.3s;
        }

        .sticky-name {
            background-color: var(--table-header-bg);
            position: sticky;
            left: 0;
            z-index: 3;
            font-weight: bold;
            box-shadow: 2px 0 5px var(--shadow-color);
            transition: background-color 0.3s;
        }

        thead th.sticky-name {
            z-index: 6;
        }
        
        .loading-message { padding: 15px; font-size: 14px; color: var(--loading-text); }
        .error-message { padding: 15px; font-size: 14px; color: var(--error-text); font-weight: bold; }
        .info-message { padding: 15px; font-size: 14px; color: var(--info-text); font-weight: bold; }
    </style>
</head>

<body>
    
    <div class="controls">
        <!-- âœ… ë‹¤í¬ëª¨ë“œ í† ê¸€ ìŠ¤ìœ„ì¹˜ (ë‚ ì§œ ì…ë ¥ ì™¼ìª½ì— ë°°ì¹˜) -->
        <div class="theme-switch-wrapper">
            <span class="theme-icon">â˜€ï¸</span>
            <label class="theme-switch">
                <input type="checkbox" id="themeToggle">
                <span class="slider"></span>
            </label>
            <span class="theme-icon">ğŸŒ™</span>
        </div>

        <input type="month" id="monthInput">
        <button id="loadButton">ì¡°íšŒ</button>
        <input type="text" id="searchInput" placeholder="ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰...">
    </div>

    <div class="table-container">
        <div id="workerTableContainer"></div>
    </div>

    <div class="tabs">
        <div class="tab active" id="tab-engineer">ê¸°ê´€ì‚¬</div>
        <div class="tab" id="tab-chief">ì°¨ì¥</div>
    </div>

    <script>
        // âœ… 1. Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        const POSITION_ENGINEER = "ê¸°ê´€ì‚¬";
        const POSITION_CHIEF = "ì°¨ì¥";

        const SUPABASE_URL = 'https://srsyxsddjbojnwvjoera.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyc3l4c2RkamJvam53dmpvZXJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NjY4NTEsImV4cCI6MjA3NDM0Mjg1MX0.wmTrMzDqBs10qL_wBeJJQTjQMuCuvfAmY6_eW2brqT8';

        const { createClient } = supabase; 
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY); 

        // âœ… 2. ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
        let selectedTab = POSITION_ENGINEER;
        let allDataForMonth = []; 
        let uniqueDates = []; 
        let isLoading = false;
        let isDarkMode = false; // âœ… ë‹¤í¬ëª¨ë“œ ìƒíƒœ

        // âœ… 3. í—¬í¼ í•¨ìˆ˜ (ë‚ ì§œ ê³„ì‚°ìš©)
        function getTodayMonth() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, "0");
            return `${year}-${month}`;
        }
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, "0");
            const day = String(today.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
        }
        function formatDate(dateString) {
            if (!dateString) return "";
            return new Date(dateString).toISOString().split("T")[0];
        }

        // âœ… ë‹¤í¬ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            }
            // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§ (ìƒ‰ìƒ ì—…ë°ì´íŠ¸)
            if (allDataForMonth.length > 0) {
                renderTableByPosition(selectedTab);
            }
        }

        // âœ… ì €ì¥ëœ í…Œë§ˆ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                isDarkMode = true;
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeToggle').checked = true;
            }
        }
        
        // âœ… 4. ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        async function loadData(startDateStr, endDateStr) {
            if (isLoading) return;
            isLoading = true;
            const container = document.getElementById("workerTableContainer");
            container.innerHTML = "<p class='loading-message'>ë°ì´í„° ë¡œë”© ì¤‘...</p>";

            uniqueDates = [];
            let currentDate = new Date(startDateStr);
            const finalEndDate = new Date(endDateStr);
            while (currentDate <= finalEndDate) {
                uniqueDates.push(currentDate.toISOString().split("T")[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            try {
                const { data, error } = await supabaseClient
                    .rpc('get_schedule_by_range', {
                        p_start_date: startDateStr,
                        p_end_date: endDateStr
                    })
                    .range(0, 10000);

                if (error) throw error; 

                if (!data || data.length === 0) {
                     container.innerHTML = "<p class='info-message'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (DBì— ê¸°ì¤€ì ì´ ì…ë ¥ë˜ì—ˆëŠ”ì§€ í™•ì¸)</p>";
                     allDataForMonth = [];
                     return;
                }

                console.log(`[loadData] APIì—ì„œ ${data.length}ê°œì˜ ë°ì´í„°ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.`);
                const uniquePositions = [...new Set(data.map(d => `"${d.staff_position}"`))];
                console.log(`[loadData] DBì— ìˆëŠ” ëª¨ë“  staff_position ê°’ë“¤: ${uniquePositions.join(', ')}`);

                allDataForMonth = data; 
                renderTableByPosition(selectedTab);

            } catch (error) {
                console.error("Error fetching data:", error);
                container.innerHTML = "<p class='error-message'>ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + error.message + "</p>";
            } finally {
                isLoading = false;
            }
        }

        // âœ… 5. "ì¡°íšŒ" ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  í•¨ìˆ˜
        function handleSearchButtonClick() {
            const monthValue = document.getElementById("monthInput").value;
            if (!monthValue) {
                alert("ì¡°íšŒí•  ì›”(Month)ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const today = new Date(getTodayDate());

            const [year, month] = monthValue.split('-').map(Number);
            const selectedMonthStartDate = new Date(year, month - 1, 1);
            const selectedMonthEndDate = new Date(year, month, 0); 

            if (selectedMonthEndDate < today) {
                const container = document.getElementById("workerTableContainer");
                container.innerHTML = `<p class='error-message'>${monthValue}ì›”ì€ ì´ë¯¸ ì§€ë‚œ ì›”ì…ë‹ˆë‹¤. ì˜¤ëŠ˜(${getTodayDate()}) ì´í›„ì˜ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>`;
                allDataForMonth = [];
                return;
            }

            let queryStartDate;
            if (selectedMonthStartDate < today) {
                queryStartDate = today; 
            } else {
                queryStartDate = selectedMonthStartDate; 
            }

            const queryStartDateStr = queryStartDate.toISOString().split("T")[0];
            const queryEndDateStr = selectedMonthEndDate.toISOString().split("T")[0];

            loadData(queryStartDateStr, queryEndDateStr);
        }

        // âœ… 6. íƒ­ ì „í™˜
        function switchTab(position) {
            selectedTab = position;
            document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
            document.getElementById(position === POSITION_ENGINEER ? "tab-engineer" : "tab-chief").classList.add("active");
            renderTableByPosition(position); 
        }

        // âœ… 7. í…Œì´ë¸” ë Œë”ë§
        function renderTableByPosition(position) {
            const container = document.getElementById("workerTableContainer");
            
            const trimmedPosition = position.trim(); 
            const searchValue = document.getElementById("searchInput").value.trim().toLowerCase();

            const tabFiltered = allDataForMonth.filter(worker => 
                worker.staff_position && worker.staff_position.trim() === trimmedPosition
            );
            
            const searchFiltered = tabFiltered.filter(worker => 
                worker.name.toLowerCase().includes(searchValue)
            );

            const nameMap = new Map();
            for (const item of searchFiltered) {
                const name = item.name;
                if (!nameMap.has(name)) {
                    nameMap.set(name, new Map());
                }
                nameMap.get(name).set(formatDate(item.date), item.turn);
            }
            
            if (nameMap.size === 0) {
                if (allDataForMonth.length === 0) {
                     container.innerHTML = "<p class='info-message'>í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ë¨¼ì € ì¡°íšŒë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”)</p>";
                } else if (tabFiltered.length === 0) {
                    container.innerHTML = `<p class='info-message'>"${trimmedPosition}" íƒ­ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (APIê°€ 1000ê°œë§Œ ë°˜í™˜í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)</p>`;
                } else {
                    container.innerHTML = "<p class='info-message'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                }
                return;
            }

            const allNames = [...nameMap.keys()].sort();

            let tableHtml = `<table>
                <thead>
                    <tr>
                        <th class="sticky-header sticky-name">ì´ë¦„</th>`;
            
            uniqueDates.forEach(date => {
                tableHtml += `<th class="sticky-header" style="color: ${getDayColor(date)};">
                    ${date.slice(5)}<br>(${getDayName(date)})
                </th>`;
            });

            tableHtml += `</tr></thead><tbody>`;

            allNames.forEach(name => {
                tableHtml += `<tr><td class="sticky-name">${name}</td>`;
                uniqueDates.forEach(date => {
                    const turn = nameMap.get(name).get(date) || "-";
                    tableHtml += `<td style="background-color: ${getTurnColor(turn, date)};">${turn}</td>`;
                });
                tableHtml += "</tr>";
            });

            tableHtml += `</tbody></table>`;
            container.innerHTML = tableHtml;
        }
        
        // âœ… í—¬í¼ í•¨ìˆ˜ë“¤
        function getDayColor(dateString) {
            const dayName = getDayName(dateString);
            if (dayName === "í† ") return "#4a90d9";
            if (dayName === "ì¼") return "#ff6b6b";
            return isDarkMode ? "#e0e0e0" : "#333";
        }

        function getDayName(dateString) {
            const days = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
            return days[new Date(dateString).getDay()];
        }

        function getTurnColor(turnText, dateString) {
            const dayName = getDayName(dateString);
            const isWeekend = dayName === "í† " || dayName === "ì¼";
            const weekendHolidayTurns = ["31", "32", "33", "34", "35", "36", "37"];

            // âœ… ë‹¤í¬ëª¨ë“œ ìƒ‰ìƒ ì ìš©
            const colors = isDarkMode ? {
                "íœ´": "#5c3a3a",
                "ëŒ€": "#3a5c3a",
                "~": "#4a4a4a",
                "default": "#2a2a3e"
            } : {
                "íœ´": "#ffcccc",
                "ëŒ€": "#d4f4c9",
                "~": "#e0e0e0",
                "default": "#ffffff"
            };

            if (isWeekend && weekendHolidayTurns.includes(turnText)) {
                return colors["íœ´"];
            }

            for (const key in colors) {
                if (key !== "default" && turnText.includes(key)) return colors[key];
            }
            return colors["default"];
        }

        function filterWorkers() {
            renderTableByPosition(selectedTab);
        }

        // âœ… ì´ˆê¸°í™”
        async function init() {
            // ì €ì¥ëœ í…Œë§ˆ ë¶ˆëŸ¬ì˜¤ê¸°
            loadSavedTheme();

            document.getElementById("monthInput").value = getTodayMonth();

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            document.getElementById("tab-engineer").addEventListener("click", () => switchTab(POSITION_ENGINEER));
            document.getElementById("tab-chief").addEventListener("click", () => switchTab(POSITION_CHIEF));
            document.getElementById("loadButton").addEventListener("click", handleSearchButtonClick);
            document.getElementById("searchInput").addEventListener("input", filterWorkers);
            
            // âœ… ë‹¤í¬ëª¨ë“œ í† ê¸€ ì´ë²¤íŠ¸
            document.getElementById("themeToggle").addEventListener("change", toggleTheme);

            const today = new Date(getTodayDate());
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + 30);

            const startDateStr = today.toISOString().split("T")[0];
            const endDateStr = endDate.toISOString().split("T")[0];

            try {
                await loadData(startDateStr, endDateStr);
            } catch (error) {
                console.error("ì´ˆê¸° ë°ì´í„° ë¡œë”© ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", init);
    </script>

</body>

</html>